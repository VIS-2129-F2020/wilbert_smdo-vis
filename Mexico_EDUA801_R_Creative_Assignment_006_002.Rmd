---
title: "Mexico_A801"
author: "Wilbert Sanchez"
date: "9/24/2020"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(foreign)
library(dplyr)
library(magrittr)
library(stringr)
library(plotly)
library(ggthemes)
library(htmlwidgets)
library(sf)
library(leaflet)
library(htmltools)
library(raster)
library(gstat)
library(spatial)
library(arm)
library(readxl)
#mapping package
#if (!require("devtools")) {install.packages("devtools")}
#devtools::install_github("diegovalle/mxmaps")
library("mxmaps")

rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```

Analyzing migration rates across various municipalities in the Southern Mexican State of Quintana Roo. I am interested in understanding which municipalities are the net-winners / losers across the state. 

For the purpose of this analysis, I only used 10 of the municipalities, since #11 has been recently created (2016) and there is no migration data from the 2015 Mexican Inter-census survey.

For this exact code to work, create a folder called "Muni_2012gw" in your working directory and extract the contents of the zipped file downloaded from [https://development-data-hub-s3-public.s3.amazonaws.com/ddhfiles/98567/muni_2012gw.zip](https://development-data-hub-s3-public.s3.amazonaws.com/ddhfiles/98567/muni_2012gw.zip) to there.

# Reading Municipal_Data
```{r reading_excel_data_Education}

WGS84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"


#extracting shapefiles
muni_shape <- st_read("Muni_2012gw/Muni_2012gw.shp")

#INEGI Codes. There was a recent (2016) creation of a new municipality - Puerto Morelos (23011). This is excluded from the QR_muni_shape which is a database from 2012. Also the INEGI book  - Principales resultados de la Encuesta Intercensal 2015 does not include it. For the purpose of this analysis, we will exclude it.

QR_muni_wPM <- c(23001, 23002, 23003, 23004, 23005, 23006, 23007, 23008, 23009, 23010, 23011)
QR_muni_w_out_PM <- c(23001, 23002, 23003, 23004, 23005, 23006, 23007, 23008, 23009, 23010, 23011)
#excludes Puerto Morelos
QR_muni_shape <- muni_shape %>% filter(CVE_ENT == 23)

#excludes Cozumel, which is an island
QR_muni_shape <- QR_muni_shape[-c(3),]

```


#Data Wrangling
```{r Adding_new_Data}

#of people that migrated into the municipality from another country or municipality

#rearraning data in order to ease adding information
QR_muni_shape %<>% arrange(CVE_MUN) 

#Source: http://coespo.qroo.gob.mx/Descargas/doc/Encuesta%20Intercensal/Principales%20Resultados%20de%20la%20Encuesta%20Intercensal%202015%20Q%20Roo.pdf. Pg 14, # of people in a municipality that are from outside that municipality
migrants_info <- c(67.8, 63, 55, 50.3, 47.5, 39.2, 37.2, 36.1, 28.1, 13.8)
migrants_info_ex_Coz <- c(63, 55, 50.3, 47.5, 39.2, 37.2, 36.1, 28.1, 13.8)

QR_muni_shape <- QR_muni_shape %>% mutate(migrants_per = migrants_info_ex_Coz) 

QR_muni_shape$label <- 
  paste(QR_muni_shape$NOM_MUN, "<br>", QR_muni_shape$migrants_per, "% of migrants in the municipality") %>%  lapply(htmltools::HTML)


```


# Mapping

Initial map showing baoundaries

```{r Initial_Maps_QR}

leaflet(QR_muni_shape) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(highlightOptions = highlightOptions(fillColor = "yellow", fillOpacity = 1), label = ~label, weight = 1)
```

Map with colors in indicate migration

```{r}
#colour palette
pal <- colorNumeric("viridis", domain = QR_muni_shape$migrants_per, na.color = "#00000000")


leaflet(QR_muni_shape) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(highlightOptions = highlightOptions(fillOpacity = 1), label = ~label, fillColor = ~pal(migrants_per), weight = 1, color = "black") %>% 
  addLegend(pal = pal, values = ~migrants_per, bins = 5, opacity = 0.7, title = "Percentage Immigrants <br> per Municipality (%)", position = "bottomright")
```  
  
Representing areas as centroid points  
```{r, message = FALSE, warning=FALSE}

# forming the centroids transform to EPSG CRS 4489, 
# and then back to WGS84
qr_muni_points <- QR_muni_shape %>%
  st_transform(4489) %>%
  st_centroid() %>% 
  st_transform(4326)

#mapping the centroids
leaflet(qr_muni_points) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addCircles(label = ~label, fillColor = ~pal(migrants_per), stroke = FALSE, radius = 5000, fillOpacity = 1) %>% 
  addLegend(pal = pal, values = ~migrants_per, bins = 5, opacity = 0.7, title = "Percentage Immigrants <br> per Municipality (%)", position = "bottomright")

```

Transforming the data sets into spatial

```{r, warning= FALSE}

qr_muni_points_sp <- qr_muni_points %>%
  st_transform(4489) %>%
  as_Spatial()

QR_muni_shape_sp <- QR_muni_shape %>%
  st_transform(4489) %>%
  as_Spatial()

```

Generate raster

```{r, warning=FALSE}

#this is creating an empty layer
QR_muni_shape_sp_raster <- raster(QR_muni_shape_sp, res=1000)

#finds the values in between the the points
gs <- gstat(formula=migrants_per~1, locations=qr_muni_points_sp)

#the interpolated points are set into the empty raster layer
idw_interp <- interpolate(QR_muni_shape_sp_raster, gs)

#mask bounds the the interpolated data into your shape 
idw_interp_clip <- mask(idw_interp, QR_muni_shape_sp)
```

Plot raster in leaflet

```{r, warning=FALSE}

leaflet(qr_muni_points) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addRasterImage(idw_interp_clip, colors = pal, opacity = 0.8) %>%
  addLegend(pal = pal, values = ~migrants_per, bins = 5, opacity = 0.7, title = "Percentage Immigrants <br> per Municipality (%)", position = "bottomright")


```



